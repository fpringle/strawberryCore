#include "board.h"
#include "eval.h"
#include "twiddle.h"

// initialise constants declared in eval.h
// indexed by phase(0=opening, 1=endgame), then colourPiece
const int16_t pieceValues[2][12] = {{100, 500, 320, 330, 900, 20000, -100, -500, -320, -330, -900, -20000},
                                    {100, 500, 320, 330, 900, 20000, -100, -500, -320, -330, -900, -20000}};

// indexed by phase(0=opening, 1=endgame), then colourPiece, then square
const int8_t pieceSquareTables[2][12][64] = {
    {
        // white pawn
        {
            0, 0, 0, 0, 0, 0, 0, 0,
            5, 10, 10, -20, -20, 10, 10, 5,
            5, -5, -10, 0, 0, -10, -5, 5,
            0, 0, 0, 20, 20, 0, 0, 0,
            5, 5, 10, 25, 25, 10, 5, 5,
            10, 10, 20, 30, 30, 20, 10, 10,
            50, 50, 50, 50, 50, 50, 50, 50,
            0, 0, 0, 0, 0, 0, 0, 0
        },

        // white rook
        {
            0, 0, 0, 5, 5, 0, 0, 0,
            -5, 0, 0, 0, 0, 0, 0, -5,
            -5, 0, 0, 0, 0, 0, 0, -5,
            -5, 0, 0, 0, 0, 0, 0, -5,
            -5, 0, 0, 0, 0, 0, 0, -5,
            -5, 0, 0, 0, 0, 0, 0, -5,
            5, 10, 10, 10, 10, 10, 10, 5,
            0, 0, 0, 0, 0, 0, 0, 0
        },

        // white knight
        {
            -50, -40, -30, -30, -30, -30, -40, -50,
                -40, -20, 0, 5, 5, 0, -20, -40,
                -30, 5, 10, 15, 15, 10, 5, -30,
                -30, 0, 15, 20, 20, 15, 0, -30,
                -30, 5, 15, 20, 20, 15, 5, -30,
                -30, 0, 10, 15, 15, 10, 0, -30,
                -40, -20, 0, 0, 0, 0, -20, -40,
                -50, -40, -30, -30, -30, -30, -40, -50
            },

        // white bishop
        {
            -20, -10, -10, -10, -10, -10, -10, -20,
                -10, 5, 0, 0, 0, 0, 5, -10,
                -10, 10, 10, 10, 10, 10, 10, -10,
                -10, 0, 10, 10, 10, 10, 0, -10,
                -10, 5, 5, 10, 10, 5, 5, -10,
                -10, 0, 5, 10, 10, 5, 0, -10,
                -10, 0, 0, 0, 0, 0, 0, -10,
                -20, -10, -10, -10, -10, -10, -10, -20
            },

        // white queen
        {
            -20, -10, -10, -5, -5, -10, -10, -20,
                -10, 0, 5, 0, 0, 0, 0, -10,
                -10, 5, 5, 5, 5, 5, 0, -10,
                0, 0, 5, 5, 5, 5, 0, -5,
                -5, 0, 5, 5, 5, 5, 0, -5,
                -10, 0, 5, 5, 5, 5, 0, -10,
                -10, 0, 0, 0, 0, 0, 0, -10,
                -20, -10, -10, -5, -5, -10, -10, -20
            },

        // white king
        {
            20, 30, 10, 0, 0, 10, 30, 20,
            20, 20, 0, 0, 0, 0, 20, 20,
            -10, -20, -20, -20, -20, -20, -20, -10,
            -20, -30, -30, -40, -40, -30, -30, -20,
            -30, -40, -40, -50, -50, -40, -40, -30,
            -30, -40, -40, -50, -50, -40, -40, -30,
            -30, -40, -40, -50, -50, -40, -40, -30,
            -30, -40, -40, -50, -50, -40, -40, -30
        },

        // black pawn
        {
            0, 0, 0, 0, 0, 0, 0, 0,
            -50, -50, -50, -50, -50, -50, -50, -50,
            -10, -10, -20, -30, -30, -20, -10, -10,
            -5, -5, -10, -25, -25, -10, -5, -5,
            0, 0, 0, -20, -20, 0, 0, 0,
            -5, 5, 10, 0, 0, 10, 5, -5,
            -5, -10, -10, 20, 20, -10, -10, -5,
            0, 0, 0, 0, 0, 0, 0, 0
        },

        // black rook
        {
            0, 0, 0, 0, 0, 0, 0, 0,
            -5, -10, -10, -10, -10, -10, -10, -5,
            +-5, 0, 0, 0, 0, 0, 0, +5,
            +-5, 0, 0, 0, 0, 0, 0, +5,
            +-5, 0, 0, 0, 0, 0, 0, +5,
            +-5, 0, 0, 0, 0, 0, 0, +5,
            +-5, 0, 0, 0, 0, 0, 0, +5,
            0, 0, 0, -5, -5, 0, 0, 0
        },

        // black knight
        {
            +50, +40, +30, +30, +30, +30, +40, +50,
                +40, +20, 0, 0, 0, 0, +20, +40,
                +30, 0, -10, -15, -15, -10, 0, +30,
                +30, -5, -15, -20, -20, -15, 5, +30,
                +30, 0, -15, -20, -20, -15, 0, +30,
                +30, -5, -10, -15, -15, -10, 5, +30,
                +40, +20, 0, -5, -5, 0, +20, +40,
                +50, +40, +30, +30, +30, +30, +40, +50
            },

        //black bishop
        {
            +20, +10, +10, +10, +10, +10, +10, +20,
                +10, 0, 0, 0, 0, 0, 0, +10,
                +10, 0, -5, -10, -10, -5, 0, +10,
                +10, -5, -5, -10, -10, -5, -5, +10,
                +10, 0, -10, -10, -10, -10, 0, +10,
                +10, -10, -10, -10, -10, -10, -10, +10,
                +10, -5, 0, 0, 0, 0, -5, +10,
                +20, +10, +10, +10, +10, +10, +10, +20
            },

        // black queen
        {
            +20, +10, +10, +5, +5, +10, +10, +20,
                +10, 0, 0, 0, 0, 0, 0, +10,
                +10, 0, -5, -5, -5, -5, 0, +10,
                +5, 0, -5, -5, -5, -5, 0, +5,
                0, 0, -5, -5, -5, -5, 0, +5,
                +10, -5, -5, -5, -5, -5, 0, +10,
                +10, 0, -5, 0, 0, 0, 0, +10,
                +20, +10, +10, +5, +5, +10, +10, +20
            },

        // black king
        {
            +30, +40, +40, +50, +50, +40, +40, +30,
                +30, +40, +40, +50, +50, +40, +40, +30,
                +30, +40, +40, +50, +50, +40, +40, +30,
                +30, +40, +40, +50, +50, +40, +40, +30,
                +20, +30, +30, +40, +40, +30, +30, +20,
                +10, +20, +20, +20, +20, +20, +20, +10,
                -20, -20, 0, 0, 0, 0, -20, -20,
                -20, -30, -10, 0, 0, -10, -30, -20
            }
    },

    {
        // white pawn
        {
            0, 0, 0, 0, 0, 0, 0, 0,
            5, 10, 10, -20, -20, 10, 10, 5,
            5, -5, -10, 0, 0, -10, -5, 5,
            0, 0, 0, 20, 20, 0, 0, 0,
            5, 5, 10, 25, 25, 10, 5, 5,
            10, 10, 20, 30, 30, 20, 10, 10,
            50, 50, 50, 50, 50, 50, 50, 50,
            0, 0, 0, 0, 0, 0, 0, 0
        },

        // white rook
        {
            0, 0, 0, 5, 5, 0, 0, 0,
            -5, 0, 0, 0, 0, 0, 0, -5,
            -5, 0, 0, 0, 0, 0, 0, -5,
            -5, 0, 0, 0, 0, 0, 0, -5,
            -5, 0, 0, 0, 0, 0, 0, -5,
            -5, 0, 0, 0, 0, 0, 0, -5,
            5, 10, 10, 10, 10, 10, 10, 5,
            0, 0, 0, 0, 0, 0, 0, 0
        },

        // white knight
        {
            -50, -40, -30, -30, -30, -30, -40, -50,
                -40, -20, 0, 5, 5, 0, -20, -40,
                -30, 5, 10, 15, 15, 10, 5, -30,
                -30, 0, 15, 20, 20, 15, 0, -30,
                -30, 5, 15, 20, 20, 15, 5, -30,
                -30, 0, 10, 15, 15, 10, 0, -30,
                -40, -20, 0, 0, 0, 0, -20, -40,
                -50, -40, -30, -30, -30, -30, -40, -50
            },

        // white bishop
        {
            -20, -10, -10, -10, -10, -10, -10, -20,
                -10, 5, 0, 0, 0, 0, 5, -10,
                -10, 10, 10, 10, 10, 10, 10, -10,
                -10, 0, 10, 10, 10, 10, 0, -10,
                -10, 5, 5, 10, 10, 5, 5, -10,
                -10, 0, 5, 10, 10, 5, 0, -10,
                -10, 0, 0, 0, 0, 0, 0, -10,
                -20, -10, -10, -10, -10, -10, -10, -20
            },

        // white queen
        {
            -20, -10, -10, -5, -5, -10, -10, -20,
                -10, 0, 5, 0, 0, 0, 0, -10,
                -10, 5, 5, 5, 5, 5, 0, -10,
                0, 0, 5, 5, 5, 5, 0, -5,
                -5, 0, 5, 5, 5, 5, 0, -5,
                -10, 0, 5, 5, 5, 5, 0, -10,
                -10, 0, 0, 0, 0, 0, 0, -10,
                -20, -10, -10, -5, -5, -10, -10, -20
            },

        // white king   - different for endgame
        {
            -50, -30, -30, -30, -30, -30, -30, -50,
            -30, -30, 0, 0, 0, 0, -30, -30,
            -30, -10, 20, 30, 30, 20, -10, -30,
            -30, -10, 30, 40, 40, 30, -10, -30,
            -30, -10, 30, 40, 40, 30, -10, -30,
            -30, -10, 20, 30, 30, 20, -10, -30,
            -30, -20, -10, 0, 0, -10, -20, -30,
            -50, -40, -30, -20, -20, -30, -40, -50
        },

        // black pawn
        {
            0, 0, 0, 0, 0, 0, 0, 0,
            -50, -50, -50, -50, -50, -50, -50, -50,
            -10, -10, -20, -30, -30, -20, -10, -10,
            -5, -5, -10, -25, -25, -10, -5, -5,
            0, 0, 0, -20, -20, 0, 0, 0,
            -5, 5, 10, 0, 0, 10, 5, -5,
            -5, -10, -10, 20, 20, -10, -10, -5,
            0, 0, 0, 0, 0, 0, 0, 0
        },

        // black rook
        {
            0, 0, 0, 0, 0, 0, 0, 0,
            -5, -10, -10, -10, -10, -10, -10, -5,
            +-5, 0, 0, 0, 0, 0, 0, +5,
            +-5, 0, 0, 0, 0, 0, 0, +5,
            +-5, 0, 0, 0, 0, 0, 0, +5,
            +-5, 0, 0, 0, 0, 0, 0, +5,
            +-5, 0, 0, 0, 0, 0, 0, +5,
            0, 0, 0, -5, -5, 0, 0, 0
        },

        // black knight
        {
            +50, +40, +30, +30, +30, +30, +40, +50,
                +40, +20, 0, 0, 0, 0, +20, +40,
                +30, 0, -10, -15, -15, -10, 0, +30,
                +30, -5, -15, -20, -20, -15, 5, +30,
                +30, 0, -15, -20, -20, -15, 0, +30,
                +30, -5, -10, -15, -15, -10, 5, +30,
                +40, +20, 0, -5, -5, 0, +20, +40,
                +50, +40, +30, +30, +30, +30, +40, +50
            },

        //black bishop
        {
            +20, +10, +10, +10, +10, +10, +10, +20,
                +10, 0, 0, 0, 0, 0, 0, +10,
                +10, 0, -5, -10, -10, -5, 0, +10,
                +10, -5, -5, -10, -10, -5, -5, +10,
                +10, 0, -10, -10, -10, -10, 0, +10,
                +10, -10, -10, -10, -10, -10, -10, +10,
                +10, -5, 0, 0, 0, 0, -5, +10,
                +20, +10, +10, +10, +10, +10, +10, +20
            },

        // black queen
        {
            +20, +10, +10, +5, +5, +10, +10, +20,
                +10, 0, 0, 0, 0, 0, 0, +10,
                +10, 0, -5, -5, -5, -5, 0, +10,
                +5, 0, -5, -5, -5, -5, 0, +5,
                0, 0, -5, -5, -5, -5, 0, +5,
                +10, -5, -5, -5, -5, -5, 0, +10,
                +10, 0, -5, 0, 0, 0, 0, +10,
                +20, +10, +10, +5, +5, +10, +10, +20
            },

        // black king - different for endgame
        {
            50, 40, 30, 20, 20, 30, 40, 50,
            30, 20, 10, 0, 0, 10, 20, 30,
            30, 10, -20, -30, -30, -20, 10, 30,
            30, 10, -30, -40, -40, -30, 10, 30,
            30, 10, -30, -40, -40, -30, 10, 30,
            30, 10, -20, -30, -30, -20, 10, 30,
            30, 30, 0, 0, 0, 0, 30, 30,
            50, 30, 30, 30, 30, 30, 30, 50
        }
    }
};

// evaluation functions

int16_t board::evaluate_material(int phase) {
    // a rudimentary evaluation function based on material
    // white is positive, black is negative

    int16_t ret = 0;
    for (int i = 0; i < 12; i++) {
        ret += count_bits_set(pieceBoards[i]) * pieceValues[phase][i];
    }
    return ret;
}

int16_t board::evaluate_pieceSquareTables(int phase) {
    int i, j;
    bitboard tmp;
    int16_t ret = 0;

    for (i = 0; i < 12; i++) {
        tmp = pieceBoards[i];
        while (tmp) {
            ret += pieceSquareTables[phase][i][first_set_bit(tmp)];
            tmp &= (tmp - 1ULL);
        }
    }
    return ret;
}

int32_t board::evaluate() {
    int phase = getPhase();
    int32_t open = evaluateOpening();
    int32_t end = evaluateEndgame();
    return (open * (256 - phase) + end * phase) / 256;
//    return evaluate_material() + evaluate_pieceSquareTables();
}

int32_t board::evaluateOpening() {
    return evaluate_material(0) + evaluate_pieceSquareTables(0);
}

int32_t board::evaluateEndgame() {
    return evaluate_material(1) + evaluate_pieceSquareTables(1);
}

int32_t board::getValue() {
    int phase = getPhase();
    return (opening_value * (256 - phase) + endgame_value * phase) / 256;
}

int32_t board::getOpeningValue() {
    return opening_value;
}

int32_t board::getEndgameValue() {
    return endgame_value;
}

int board::getPhase() {
    int pawnPhase = 0;
    int knightPhase = 1;
    int bishopPhase = 1;
    int rookPhase = 2;
    int queenPhase = 4;
    int totalPhase = pawnPhase*16 + knightPhase*4 + bishopPhase*4
                   + rookPhase*4 + queenPhase*2;

    int phase = totalPhase;

    phase -= pawnPhase * num_pieces_left(whitePawn);
    phase -= knightPhase * num_pieces_left(whiteKnight);
    phase -= bishopPhase * num_pieces_left(whiteBishop);
    phase -= rookPhase * num_pieces_left(whiteRook);
    phase -= queenPhase * num_pieces_left(whiteQueen);

    phase -= pawnPhase * num_pieces_left(blackPawn);
    phase -= knightPhase * num_pieces_left(blackKnight);
    phase -= bishopPhase * num_pieces_left(blackBishop);
    phase -= rookPhase * num_pieces_left(blackRook);
    phase -= queenPhase * num_pieces_left(blackQueen);

    phase = (phase * 256 + (totalPhase / 2)) / totalPhase;

    return phase;
}





